<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Happy New Year - Photo Booth</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GPLJLSF9S0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GPLJLSF9S0', {
        // éš±ç§å‹å–„è¨­å®š
        anonymize_ip: true,
        allow_google_signals: false,
        allow_ad_personalization_signals: false
      });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#0B1026',
                        gold: '#D4AF37',
                        'gold-light': '#F3E5AB',
                        'glass': 'rgba(255, 255, 255, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #0B1026;
            color: #F3E5AB;
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        #particles-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        #stage-parent {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #D4AF37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            background-color: #000;
            position: relative;
            touch-action: none;
            transition: aspect-ratio 0.3s ease;
        }

        /* æ¡Œé¢ç‰ˆï¼šå…è¨±æ›´å¤§çš„ç•«å¸ƒä»¥å®Œæ•´é¡¯ç¤ºå¤–æ¡† */
        @media (min-width: 768px) {
            #stage-parent {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            #stage-parent {
                max-width: 700px;
            }
        }

        #file-input { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .frame-thumb {
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
        }
        .frame-thumb-contain {
            background-size: contain;
            background-repeat: no-repeat;
            background-color: #000;
        }

        /* Loading å‹•ç•«æ¨£å¼ */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 300ms; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 300ms; }
    </style>
</head>
<body class="bg-midnight min-h-screen flex flex-col items-center">

    <canvas id="particles-canvas"></canvas>

    <div class="relative z-10 w-full max-w-md md:max-w-2xl lg:max-w-3xl px-4 py-4 flex flex-col gap-3 h-screen max-h-screen overflow-y-auto no-scrollbar">
        
        <header class="text-center flex-shrink-0">
            <h1 class="text-2xl font-bold text-gold tracking-widest drop-shadow-md">2026 NEW YEAR</h1>
        </header>

        <!-- ç•«å¸ƒå€åŸŸ -->
        <div class="flex-shrink-0 w-full flex justify-center">
            <div id="stage-parent" class="rounded-lg overflow-hidden relative">
                <div id="container"></div>
                
                <!-- ğŸ”¥ è¼‰å…¥ä¸­çš„é®ç½©å±¤ (Loading Overlay) ğŸ”¥ -->
                <div id="loading-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm hidden transition-opacity duration-300">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gold mb-3 drop-shadow-[0_0_10px_rgba(212,175,55,0.8)]"></i>
                    <span class="text-gold text-xs font-bold tracking-widest uppercase">Loading Frame...</span>
                </div>

                <!-- æç¤ºå±¤ -->
                <div id="upload-hint" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none bg-black/40">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-gold mb-2 opacity-80"></i>
                    <span class="text-gold-light text-sm opacity-80">Tap 'Photo' to Upload</span>
                </div>
            </div>
        </div>

        <!-- ä¸‹æ–¹æ§åˆ¶å€ -->
        <div class="flex-grow flex flex-col justify-end gap-3 pb-4">
            
            <!-- åœ–æ¡†é¸æ“‡å™¨ -->
            <div class="bg-glass backdrop-blur-md rounded-xl p-3 border border-gold/20 shadow-lg">
                <!-- ğŸ”¥ é€™è£¡ä¿®æ”¹äº†ï¼šå¢åŠ äº† id="frame-name-label" ä¸¦ä¸”åŠ ä¸Š truncate é˜²æ­¢åå­—å¤ªé•·è·‘ç‰ˆ -->
                <p class="text-[10px] text-gold mb-2 uppercase font-semibold tracking-wider flex justify-between items-center">
                    <span id="frame-name-label" class="truncate max-w-[150px] flex items-center gap-1">
                        <i class="fa-solid fa-palette text-[9px] opacity-70"></i> Select Style
                    </span>
                    <span id="frame-size-label" class="text-gray-300 flex-shrink-0">Loading...</span>
                </p>
                <div class="flex overflow-x-auto gap-3 scrollbar-hide pb-1" id="frame-gallery">
                    <!-- Javascript ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æŒ‰éˆ•çµ„ -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('file-input').click()" 
                        class="flex items-center justify-center gap-2 py-3 px-4 rounded-full border border-gold text-gold hover:bg-gold hover:text-midnight transition-all duration-300 font-semibold text-sm shadow-[0_0_10px_rgba(212,175,55,0.2)]">
                    <i class="fa-solid fa-camera"></i>
                    <span>Photo</span>
                </button>
                <input type="file" id="file-input" accept="image/*">

                <button id="download-btn"
                        class="flex items-center justify-center gap-2 py-3 px-4 rounded-full bg-gradient-to-r from-gold to-yellow-600 text-midnight font-bold shadow-lg hover:scale-105 transition-transform text-sm disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-share-nodes" id="btn-icon"></i>
                    <span id="btn-text">Save / Share</span>
                </button>
            </div>
            
            <p class="text-center text-[10px] text-gray-400">
                Pinch to Zoom â€¢ Drag to Move
            </p>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // 1. è¼‰å…¥ä¸»é¡Œé…ç½®
        // ==========================================
        import { themeConfig } from './src/theme-config.js';

        // å¾ theme-config.js è¼‰å…¥ new-year-v2 ä¸»é¡Œé…ç½®
        const theme = themeConfig.themes['new-year-v2'];
        const frameStyles = theme.frameStyles;

        // ==========================================
        // 2. åœ–æ¡†è³‡æ–™åº« - å¾é…ç½®è‡ªå‹•ç”Ÿæˆ
        // ==========================================
        const frames = [];

        // ç‚ºæ¯å€‹é¢¨æ ¼ç”Ÿæˆæ­£æ–¹å½¢å’Œç›´å¼æ ¼å¼
        frameStyles.forEach(style => {
            const formats = style.availableFormats;

            // æ­£æ–¹å½¢æ ¼å¼ (1080x1080)
            if (formats.includes('square')) {
                frames.push({
                    id: `${style.value}_square`,
                    src: `assets/frames/frame_square_${style.value}_1080x1080.png`,
                    width: 1080,
                    height: 1080,
                    name: `${style.label} (æ­£æ–¹å½¢)`
                });
            }

            // ç›´å¼æ ¼å¼ (1080x1350)
            if (formats.includes('portrait')) {
                frames.push({
                    id: `${style.value}_portrait`,
                    src: `assets/frames/frame_portrait_${style.value}_1080x1350.png`,
                    width: 1080,
                    height: 1350,
                    name: `${style.label} (ç›´å¼)`
                });
            }
        });

        // ==========================================
        // 2. ç³»çµ±é‚è¼¯
        // ==========================================

        const stageParent = document.getElementById('stage-parent');
        const loadingOverlay = document.getElementById('loading-overlay'); // å–å¾— Loading å…ƒç´ 

        // è¨ˆç®—æœ€ä½³ç•«å¸ƒå¯¬åº¦ï¼šç¢ºä¿åœ¨æ¡Œé¢ç‰ˆèƒ½å®Œæ•´é¡¯ç¤ºå¤–æ¡†
        function calculateOptimalWidth() {
            const screenWidth = window.innerWidth;

            // è¡Œå‹•ç‰ˆï¼šä¿æŒåŸæœ‰é‚è¼¯
            if (screenWidth < 768) {
                return Math.min(screenWidth - 32, 500);
            }

            // æ¡Œé¢ç‰ˆï¼šæ ¹æ“šå¯ç”¨é«˜åº¦è¨ˆç®—ï¼Œç¢ºä¿ç›´å¼æ¡†æ¶ï¼ˆ1:1.25ï¼‰èƒ½å®Œæ•´é¡¯ç¤º
            // é ç•™ç©ºé–“çµ¦ header (50px)ã€controls (200px)ã€padding (50px) = ç´„ 300px
            const availableHeight = window.innerHeight - 300;
            const maxWidthByHeight = availableHeight / 1.25;

            // æ ¹æ“šè¢å¹•å¯¬åº¦è¨­å®šä¸Šé™
            const maxWidthByScreen = screenWidth < 1024 ? 600 : 700;

            return Math.min(screenWidth - 32, maxWidthByHeight, maxWidthByScreen);
        }

        const initialWidth = calculateOptimalWidth();

        const stage = new Konva.Stage({
            container: 'container',
            width: initialWidth,
            height: initialWidth,
        });

        const photoLayer = new Konva.Layer();
        const frameLayer = new Konva.Layer();
        stage.add(photoLayer);
        stage.add(frameLayer);

        const tr = new Konva.Transformer({
            nodes: [],
            centeredScaling: true,
            rotateEnabled: true,
            anchorSize: 20,
            borderStroke: '#D4AF37',
            anchorStroke: '#D4AF37',
            anchorFill: '#0B1026',
        });
        photoLayer.add(tr);

        stage.on('tap click', (e) => {
            if (e.target === stage) {
                tr.nodes([]);
            }
        });

        // --- æ ¸å¿ƒï¼šè¼‰å…¥åœ–æ¡† ---
        let currentFrameNode = null;
        let currentFrameData = null;

        function loadFrame(frameData) {
            currentFrameData = frameData;

            loadingOverlay.classList.remove('hidden');

            const ratio = frameData.height / frameData.width;
            stageParent.style.aspectRatio = `${frameData.width} / ${frameData.height}`;
            
            // ğŸ”¥ é€™è£¡ä¿®æ”¹äº†ï¼šæ›´æ–°åç¨± (frame-name-label) èˆ‡ å°ºå¯¸ (frame-size-label)
            // ä½¿ç”¨ innerHTML å¯ä»¥åŠ å…¥ iconï¼Œæˆ–è€…ç›´æ¥ç”¨ innerText
            document.getElementById('frame-name-label').innerHTML = `<i class="fa-solid fa-palette text-[9px] opacity-70"></i> ${frameData.name}`;
            document.getElementById('frame-size-label').innerText = `${frameData.width} x ${frameData.height}`;

            const currentStageWidth = stage.width();
            const newStageHeight = currentStageWidth * ratio;

            stage.height(newStageHeight);
            stage.scale({ x: 1, y: 1 });

            const imgObj = new Image();
            imgObj.crossOrigin = 'Anonymous';
            
            imgObj.onload = function() {
                if (currentFrameNode) currentFrameNode.destroy();

                currentFrameNode = new Konva.Image({
                    image: imgObj,
                    x: 0,
                    y: 0,
                    width: currentStageWidth,
                    height: newStageHeight,
                    listening: false, 
                });

                frameLayer.add(currentFrameNode);
                frameLayer.draw();
                photoLayer.draw();

                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                }, 300);
            };

            imgObj.onerror = function() {
                loadingOverlay.classList.add('hidden');
                alert("ç„¡æ³•è¼‰å…¥åœ–æ¡†ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–åœ–ç‰‡è·¯å¾‘ã€‚");
            };

            imgObj.src = frameData.src;
        }

        // --- ç”Ÿæˆé¸å–® ---
        const gallery = document.getElementById('frame-gallery');
        frames.forEach((frame, index) => {
            const btn = document.createElement('div');
            const isTall = frame.height > frame.width;
            const thumbClass = isTall ? 'frame-thumb-contain' : 'frame-thumb';
            
            btn.className = `flex-shrink-0 w-16 h-16 rounded-lg border-2 border-gold/30 bg-midnight cursor-pointer hover:border-gold transition-all overflow-hidden relative ${thumbClass}`;
            btn.style.backgroundImage = `url(${frame.src})`;
            
            btn.onclick = () => {
                document.querySelectorAll('#frame-gallery > div').forEach(d => d.classList.remove('ring-2', 'ring-gold'));
                btn.classList.add('ring-2', 'ring-gold');
                loadFrame(frame);
            };

            if (index === 0) btn.click();
            gallery.appendChild(btn);
        });

        // --- ä¸Šå‚³é‚è¼¯ ---
        let userImgNode = null;
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.body.style.cursor = 'wait';

            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image();
                imgObj.onload = function() {
                    if (userImgNode) userImgNode.destroy();

                    const stageW = stage.width();
                    const stageH = stage.height();
                    const scale = Math.max(stageW / imgObj.width, stageH / imgObj.height);

                    userImgNode = new Konva.Image({
                        image: imgObj,
                        x: stageW / 2,
                        y: stageH / 2,
                        width: imgObj.width,
                        height: imgObj.height,
                        scaleX: scale,
                        scaleY: scale,
                        offset: { x: imgObj.width / 2, y: imgObj.height / 2 },
                        draggable: true,
                    });

                    photoLayer.add(userImgNode);
                    tr.nodes([userImgNode]);
                    tr.moveToTop();
                    document.getElementById('upload-hint').style.display = 'none';
                    photoLayer.draw();
                    
                    document.body.style.cursor = 'default';
                };
                imgObj.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- ğŸ”¥ æ ¸å¿ƒï¼šä¸‹è¼‰èˆ‡åˆ†äº«é‚è¼¯ (Web Share API) ---
        const downloadBtn = document.getElementById('download-btn');
        const btnText = document.getElementById('btn-text');
        const btnIcon = document.getElementById('btn-icon');

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ dataURL è½‰æ›ç‚º File ç‰©ä»¶
        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        // è¼”åŠ©å‡½æ•¸ï¼šåŸ·è¡Œå‚³çµ±ä¸‹è¼‰
        function fallbackDownload(dataURL, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        downloadBtn.addEventListener('click', async function() {
            // 1. UI ç‹€æ…‹æ›´æ–°ï¼šé¡¯ç¤ºè™•ç†ä¸­
            const originalText = btnText.innerText;
            const originalIconClass = btnIcon.className;

            downloadBtn.disabled = true;
            btnText.innerText = "Processing...";
            btnIcon.className = "fa-solid fa-circle-notch fa-spin";

            try {
                // çµ¦ UI ä¸€é»æ™‚é–“æ¸²æŸ“ (å°æŠ€å·§ï¼šé¿å…é•·æ™‚é–“ JS é˜»å¡å°è‡´ UI å¡åœ¨èˆŠç‹€æ…‹)
                await new Promise(resolve => requestAnimationFrame(resolve));
                await new Promise(resolve => setTimeout(resolve, 50));

                // 2. æº–å‚™åœ–ç‰‡è³‡æ–™
                tr.hide(); // éš±è—ç·¨è¼¯æ¡†
                photoLayer.draw();

                const pixelRatio = currentFrameData.width / stage.width();
                const dataURL = stage.toDataURL({ pixelRatio: pixelRatio });
                const filename = `2026-Photo-${currentFrameData.width}x${currentFrameData.height}.png`;

                // 3. åˆ¤æ–·æ˜¯å¦æ”¯æ´ Web Share API
                let shareSuccess = false;
                
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ navigator.share ä¸”èƒ½å¤ åˆ†äº«æª”æ¡ˆ
                if (navigator.share && navigator.canShare) {
                    const file = dataURLtoFile(dataURL, filename);
                    const shareData = {
                        files: [file],
                        title: 'My 2026 New Year Photo',
                        text: 'Celebrate 2026 with me! âœ¨'
                    };

                    if (navigator.canShare(shareData)) {
                        btnText.innerText = "Sharing...";
                        try {
                            await navigator.share(shareData);
                            shareSuccess = true;
                            // åˆ†äº«æˆåŠŸå¾Œï¼Œé€šå¸¸ä¸éœ€è¦åšä»€éº¼ï¼Œå› ç‚ºä½¿ç”¨è€…å·²ç¶“åœ¨å…¶ä»– App äº†
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Share failed:', err);
                                // å¦‚æœä¸æ˜¯ä½¿ç”¨è€…å–æ¶ˆï¼Œè€Œæ˜¯å‡ºéŒ¯ï¼Œå‰‡é™ç´šç‚ºä¸‹è¼‰
                                fallbackDownload(dataURL, filename);
                            }
                            // å¦‚æœæ˜¯ AbortError (ä½¿ç”¨è€…è‡ªå·±å–æ¶ˆåˆ†äº«)ï¼Œå‰‡ç•¶ä½œæ²’äº‹ç™¼ç”Ÿ
                            shareSuccess = true; // è¦–ç‚ºå·²è™•ç†ï¼Œä¸éœ€ä¸‹è¼‰
                        }
                    }
                }

                // 4. å¦‚æœä¸æ”¯æ´åˆ†äº« (Desktop) æˆ–åˆ†äº«æ¢ä»¶ä¸ç¬¦ï¼Œå‰‡åŸ·è¡Œå‚³çµ±ä¸‹è¼‰
                if (!shareSuccess) {
                    btnText.innerText = "Saving...";
                    fallbackDownload(dataURL, filename);
                }

            } catch (err) {
                console.error(err);
                alert("å„²å­˜/åˆ†äº«å¤±æ•—ï¼Œè«‹é‡è©¦");
            } finally {
                // 5. æ¢å¾© UI èˆ‡ç·¨è¼¯æ¡†
                tr.show();
                photoLayer.draw();
                
                downloadBtn.disabled = false;
                btnText.innerText = originalText;
                btnIcon.className = originalIconClass;
            }
        });

        // RWDï¼šè¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—ç•«å¸ƒå¤§å°
        window.addEventListener('resize', () => {
            const newWidth = calculateOptimalWidth();
            if (currentFrameData) {
                const ratio = currentFrameData.height / currentFrameData.width;
                stage.width(newWidth);
                stage.height(newWidth * ratio);
                if (currentFrameNode) {
                    currentFrameNode.width(newWidth);
                    currentFrameNode.height(newWidth * ratio);
                }
                stage.draw();
            }
        });

        // ç²’å­å‹•ç•«
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speed = Math.random() * 1 + 0.2;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.y += this.speed;
                if (this.y > canvas.height) { this.reset(); this.y = -10; }
            }
            draw() {
                ctx.fillStyle = `rgba(212, 175, 55, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        for(let i=0; i<50; i++) particles.push(new Particle());
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
