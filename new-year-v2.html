<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 Happy New Year - Photo Booth</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GPLJLSF9S0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GPLJLSF9S0', {
        // éš±ç§å‹å–„è¨­å®š
        anonymize_ip: true,
        allow_google_signals: false,
        allow_ad_personalization_signals: false
      });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        midnight: '#0B1026',
                        gold: '#D4AF37',
                        'gold-light': '#F3E5AB',
                        'glass': 'rgba(255, 255, 255, 0.1)'
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/konva@9.2.0/konva.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #0B1026;
            color: #F3E5AB;
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        #particles-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        #stage-parent {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #D4AF37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            background: linear-gradient(135deg, #1a1f3a 0%, #0B1026 100%);
            position: relative;
            touch-action: none;
            transition: aspect-ratio 0.3s ease;
        }

        /* æ¡Œé¢ç‰ˆï¼šå…è¨±æ›´å¤§çš„ç•«å¸ƒä»¥å®Œæ•´é¡¯ç¤ºå¤–æ¡† */
        @media (min-width: 768px) {
            #stage-parent {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            #stage-parent {
                max-width: 700px;
            }
        }

        #file-input { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .frame-thumb {
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
        }
        .frame-thumb-contain {
            background-size: contain;
            background-repeat: no-repeat;
            background-color: #000;
        }

        /* Loading å‹•ç•«æ¨£å¼ */
        .fade-enter { opacity: 0; }
        .fade-enter-active { opacity: 1; transition: opacity 300ms; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 300ms; }
    </style>
</head>
<body class="bg-midnight min-h-screen flex flex-col items-center">

    <canvas id="particles-canvas"></canvas>

    <div class="relative z-10 w-full max-w-md md:max-w-2xl lg:max-w-3xl px-4 py-4 flex flex-col gap-3 h-screen max-h-screen overflow-y-auto no-scrollbar">
        
        <header class="text-center flex-shrink-0">
            <h1 class="text-2xl font-bold text-gold tracking-widest drop-shadow-md">2026 NEW YEAR</h1>
        </header>

        <!-- ç•«å¸ƒå€åŸŸ -->
        <div class="flex-shrink-0 w-full flex justify-center">
            <div id="stage-parent" class="rounded-lg overflow-hidden relative">
                <div id="container"></div>
                
                <!-- ğŸ”¥ è¼‰å…¥ä¸­çš„é®ç½©å±¤ (Loading Overlay) ğŸ”¥ -->
                <div id="loading-overlay" class="absolute inset-0 z-50 flex-col items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity duration-300 hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gold mb-3 drop-shadow-[0_0_10px_rgba(212,175,55,0.8)]"></i>
                    <span class="text-gold text-xs font-bold tracking-widest uppercase">Loading Frame...</span>
                </div>

                <!-- æç¤ºå±¤ -->
                <div id="upload-hint" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer transition-all duration-200">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-gold mb-2 drop-shadow-[0_0_8px_rgba(212,175,55,0.8)]"></i>
                    <span class="text-gold text-sm font-semibold drop-shadow-[0_0_8px_rgba(0,0,0,0.8)]">é»æ“Šæ­¤è™•ä¸Šå‚³ç…§ç‰‡æˆ–æ‹ç…§</span>
                </div>
            </div>
        </div>

        <!-- ä¸‹æ–¹æ§åˆ¶å€ -->
        <div class="flex-grow flex flex-col justify-end gap-3 pb-4">
            
            <!-- åœ–æ¡†é¸æ“‡å™¨ -->
            <div class="bg-glass backdrop-blur-md rounded-xl p-3 border border-gold/20 shadow-lg">
                <!-- ğŸ”¥ é€™è£¡ä¿®æ”¹äº†ï¼šå¢åŠ äº† id="frame-name-label" ä¸¦ä¸”åŠ ä¸Š truncate é˜²æ­¢åå­—å¤ªé•·è·‘ç‰ˆ -->
                <p class="text-[10px] text-gold mb-2 uppercase font-semibold tracking-wider flex justify-between items-center">
                    <span id="frame-name-label" class="truncate max-w-[150px] flex items-center gap-1">
                        <i class="fa-solid fa-palette text-[9px] opacity-70"></i> Select Style
                    </span>
                    <span id="frame-size-label" class="text-gray-300 flex-shrink-0">Loading...</span>
                </p>
                <div class="flex overflow-x-auto gap-3 scrollbar-hide pb-1" id="frame-gallery">
                    <!-- Javascript ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æŒ‰éˆ•çµ„ -->
            <div class="grid grid-cols-3 gap-2">
                <!-- ä¸Šå‚³ç…§ç‰‡æŒ‰éˆ• -->
                <button onclick="document.getElementById('file-input').click()"
                        class="flex flex-col items-center justify-center gap-1 py-3 px-2 rounded-xl border border-gold text-gold hover:bg-gold hover:text-midnight transition-all duration-300 font-semibold text-xs shadow-[0_0_10px_rgba(212,175,55,0.2)]">
                    <i class="fa-solid fa-camera text-lg"></i>
                    <span>Photo</span>
                </button>
                <input type="file" id="file-input" accept="image/*">

                <!-- åˆ†äº«æŒ‰éˆ•ï¼ˆWeb Share APIï¼‰-->
                <button id="share-btn"
                        class="flex flex-col items-center justify-center gap-1 py-3 px-2 rounded-xl bg-gradient-to-r from-gold to-yellow-600 text-midnight font-bold shadow-lg hover:scale-105 transition-transform text-xs disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-share-nodes text-lg" id="share-icon"></i>
                    <span id="share-text">Share</span>
                </button>

                <!-- ç›´æ¥ä¸‹è¼‰æŒ‰éˆ• -->
                <button id="download-btn"
                        class="flex flex-col items-center justify-center gap-1 py-3 px-2 rounded-xl border border-gold text-gold hover:bg-gold hover:text-midnight transition-all duration-300 font-semibold text-xs shadow-[0_0_10px_rgba(212,175,55,0.2)] disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-download text-lg" id="download-icon"></i>
                    <span id="download-text">Download</span>
                </button>
            </div>
            
            <p class="text-center text-[10px] text-gray-400">
                Pinch to Zoom & Rotate â€¢ Drag to Move
            </p>
        </div>
    </div>

    <script type="module">
        // ==========================================
        // 1. è¼‰å…¥ä¸»é¡Œé…ç½®
        // ==========================================
        import { themeConfig } from './src/theme-config.js';

        // å¾ theme-config.js è¼‰å…¥ new-year-v2 ä¸»é¡Œé…ç½®
        const theme = themeConfig.themes['new-year-v2'];
        const frameStyles = theme.frameStyles;

        // ==========================================
        // 2. åœ–æ¡†è³‡æ–™åº« - å¾é…ç½®è‡ªå‹•ç”Ÿæˆ
        // ==========================================
        const frames = [];

        // ç‚ºæ¯å€‹é¢¨æ ¼ç”Ÿæˆæ­£æ–¹å½¢å’Œç›´å¼æ ¼å¼
        frameStyles.forEach(style => {
            const formats = style.availableFormats;

            // æ­£æ–¹å½¢æ ¼å¼ (1080x1080)
            if (formats.includes('square')) {
                frames.push({
                    id: `${style.value}_square`,
                    src: `assets/frames/frame_square_${style.value}_1080x1080.png`,
                    width: 1080,
                    height: 1080,
                    name: `${style.label} (æ­£æ–¹å½¢)`
                });
            }

            // ç›´å¼æ ¼å¼ (1080x1350)
            if (formats.includes('portrait')) {
                frames.push({
                    id: `${style.value}_portrait`,
                    src: `assets/frames/frame_portrait_${style.value}_1080x1350.png`,
                    width: 1080,
                    height: 1350,
                    name: `${style.label} (ç›´å¼)`
                });
            }
        });

        // ==========================================
        // 2. ç³»çµ±é‚è¼¯
        // ==========================================

        const stageParent = document.getElementById('stage-parent');
        const loadingOverlay = document.getElementById('loading-overlay'); // å–å¾— Loading å…ƒç´ 

        // è¨ˆç®—æœ€ä½³ç•«å¸ƒå¯¬åº¦ï¼šç¢ºä¿åœ¨æ¡Œé¢ç‰ˆèƒ½å®Œæ•´é¡¯ç¤ºå¤–æ¡†
        function calculateOptimalWidth() {
            const screenWidth = window.innerWidth;

            // è¡Œå‹•ç‰ˆï¼šä¿æŒåŸæœ‰é‚è¼¯
            if (screenWidth < 768) {
                return Math.min(screenWidth - 32, 500);
            }

            // æ¡Œé¢ç‰ˆï¼šæ ¹æ“šå¯ç”¨é«˜åº¦è¨ˆç®—ï¼Œç¢ºä¿ç›´å¼æ¡†æ¶ï¼ˆ1:1.25ï¼‰èƒ½å®Œæ•´é¡¯ç¤º
            // é ç•™ç©ºé–“çµ¦ header (50px)ã€controls (200px)ã€padding (50px) = ç´„ 300px
            const availableHeight = window.innerHeight - 300;
            const maxWidthByHeight = availableHeight / 1.25;

            // æ ¹æ“šè¢å¹•å¯¬åº¦è¨­å®šä¸Šé™
            const maxWidthByScreen = screenWidth < 1024 ? 600 : 700;

            return Math.min(screenWidth - 32, maxWidthByHeight, maxWidthByScreen);
        }

        const initialWidth = calculateOptimalWidth();

        const stage = new Konva.Stage({
            container: 'container',
            width: initialWidth,
            height: initialWidth,
        });

        const photoLayer = new Konva.Layer();
        const frameLayer = new Konva.Layer();
        stage.add(photoLayer);
        stage.add(frameLayer);

        const tr = new Konva.Transformer({
            nodes: [],
            centeredScaling: true,
            rotateEnabled: true,
            anchorSize: 20,
            borderStroke: '#D4AF37',
            anchorStroke: '#D4AF37',
            anchorFill: '#0B1026',
        });
        photoLayer.add(tr);

        stage.on('tap click', (e) => {
            if (e.target === stage) {
                tr.nodes([]);
            }
        });

        // --- æ ¸å¿ƒï¼šè¼‰å…¥åœ–æ¡† ---
        let currentFrameNode = null;
        let currentFrameData = null;

        function loadFrame(frameData) {
            currentFrameData = frameData;

            // ğŸ”¥ ç¢ºä¿ loading é¡¯ç¤ºï¼ˆç§»é™¤ hidden classï¼‰
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.style.display = 'flex';

            const ratio = frameData.height / frameData.width;

            // ğŸ†• iOS Safari ä¿®å¾©ï¼šåŒæ™‚è¨­å®š aspect-ratio å’Œæ˜ç¢ºçš„ height
            stageParent.style.aspectRatio = `${frameData.width} / ${frameData.height}`;

            // ğŸ”¥ é€™è£¡ä¿®æ”¹äº†ï¼šæ›´æ–°åç¨± (frame-name-label) èˆ‡ å°ºå¯¸ (frame-size-label)
            // ä½¿ç”¨ innerHTML å¯ä»¥åŠ å…¥ iconï¼Œæˆ–è€…ç›´æ¥ç”¨ innerText
            document.getElementById('frame-name-label').innerHTML = `<i class="fa-solid fa-palette text-[9px] opacity-70"></i> ${frameData.name}`;
            document.getElementById('frame-size-label').innerText = `${frameData.width} x ${frameData.height}`;

            const currentStageWidth = stage.width();
            const newStageHeight = currentStageWidth * ratio;

            // ğŸ†• iOS Safari ä¿®å¾©ï¼šæ˜ç¢ºè¨­å®šå®¹å™¨é«˜åº¦
            stageParent.style.height = `${newStageHeight}px`;

            stage.height(newStageHeight);
            stage.scale({ x: 1, y: 1 });

            const imgObj = new Image();
            imgObj.crossOrigin = 'Anonymous';
            
            imgObj.onload = function() {
                if (currentFrameNode) currentFrameNode.destroy();

                currentFrameNode = new Konva.Image({
                    image: imgObj,
                    x: 0,
                    y: 0,
                    width: currentStageWidth,
                    height: newStageHeight,
                    listening: false,
                });

                frameLayer.add(currentFrameNode);
                frameLayer.draw();
                photoLayer.draw();

                // ğŸ”¥ è¼‰å…¥å®Œæˆï¼šéš±è— loading overlay
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    loadingOverlay.style.display = 'none';
                }, 300);
            };

            imgObj.onerror = function() {
                loadingOverlay.classList.add('hidden');
                loadingOverlay.style.display = 'none';
                alert("ç„¡æ³•è¼‰å…¥åœ–æ¡†ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–åœ–ç‰‡è·¯å¾‘ã€‚");
                console.error('åœ–æ¡†è¼‰å…¥å¤±æ•—:', frameData.src);
            };

            imgObj.src = frameData.src;
        }

        // --- ç”Ÿæˆé¸å–® ---
        const gallery = document.getElementById('frame-gallery');
        let firstFrameBtn = null;

        frames.forEach((frame, index) => {
            const btn = document.createElement('div');
            const isTall = frame.height > frame.width;
            const thumbClass = isTall ? 'frame-thumb-contain' : 'frame-thumb';

            btn.className = `flex-shrink-0 w-16 h-16 rounded-lg border-2 border-gold/30 bg-midnight cursor-pointer hover:border-gold transition-all overflow-hidden relative ${thumbClass}`;
            btn.style.backgroundImage = `url(${frame.src})`;

            btn.onclick = () => {
                document.querySelectorAll('#frame-gallery > div').forEach(d => d.classList.remove('ring-2', 'ring-gold'));
                btn.classList.add('ring-2', 'ring-gold');
                loadFrame(frame);
            };

            if (index === 0) firstFrameBtn = btn;
            gallery.appendChild(btn);
        });

        // ğŸ”¥ ç¢ºä¿åœ¨ DOM å’Œæ‰€æœ‰è³‡æºæº–å‚™å¥½å¾Œæ‰è¼‰å…¥ç¬¬ä¸€å€‹åœ–æ¡†
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => firstFrameBtn?.click(), 100);
            });
        } else {
            // DOM å·²ç¶“è¼‰å…¥å®Œæˆ
            setTimeout(() => firstFrameBtn?.click(), 100);
        }

        // --- é»æ“Šç•«å¸ƒä¸­å¤®ä¸Šå‚³ç…§ç‰‡ ---
        const uploadHint = document.getElementById('upload-hint');
        const fileInput = document.getElementById('file-input');

        uploadHint.addEventListener('click', function() {
            fileInput.click();
        });

        // --- ğŸ¯ é›™æŒ‡æ‰‹å‹¢ç³»çµ± (å¹³æ»‘ç¸®æ”¾å’Œæ—‹è½‰) ---
        let touches = new Map();
        let lastDistance = 0;
        let lastAngle = 0;
        let gestureActive = false;

        // è¨ˆç®—å…©é»è·é›¢
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        // è¨ˆç®—å…©é»è§’åº¦
        function getAngle(p1, p2) {
            return Math.atan2(p2.y - p1.y, p2.x - p1.x);
        }

        // é—œéµï¼šè™•ç†è§’åº¦è·³èºå•é¡Œ
        function getRotationDelta(oldAngle, newAngle) {
            let delta = newAngle - oldAngle;

            // è™•ç†è·¨è¶Š Â±180Â° é‚Šç•Œçš„æƒ…æ³
            if (delta > Math.PI) {
                delta -= 2 * Math.PI;
            } else if (delta < -Math.PI) {
                delta += 2 * Math.PI;
            }

            return delta;
        }

        // å–å¾—ç›¸å°æ–¼ stage çš„è§¸æ§åº§æ¨™
        function getStagePointerPosition(touch) {
            const rect = stageParent.getBoundingClientRect();
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        // TouchStart: è¨˜éŒ„è§¸æ§é»
        stageParent.addEventListener('touchstart', (e) => {
            if (!userImgNode) return;

            // æ›´æ–°è§¸æ§é»è¨˜éŒ„
            Array.from(e.touches).forEach(touch => {
                const pos = getStagePointerPosition(touch);
                touches.set(touch.identifier, pos);
            });

            // é›™æŒ‡æ‰‹å‹¢é–‹å§‹
            if (touches.size === 2) {
                gestureActive = true;
                const touchArray = Array.from(touches.values());
                lastDistance = getDistance(touchArray[0], touchArray[1]);
                lastAngle = getAngle(touchArray[0], touchArray[1]);

                // ç¦ç”¨å–®æŒ‡æ‹–æ‹½ï¼Œé¿å…è¡çª
                userImgNode.draggable(false);
                tr.hide(); // éš±è— Transformer é¿å…å¹²æ“¾
                photoLayer.draw();
            }
        }, { passive: true });

        // TouchMove: è™•ç†é›™æŒ‡ç¸®æ”¾å’Œæ—‹è½‰
        stageParent.addEventListener('touchmove', (e) => {
            if (!userImgNode || !gestureActive) return;

            // æ›´æ–°è§¸æ§é»ä½ç½®
            Array.from(e.touches).forEach(touch => {
                const pos = getStagePointerPosition(touch);
                touches.set(touch.identifier, pos);
            });

            if (touches.size === 2) {
                const touchArray = Array.from(touches.values());
                const currentDistance = getDistance(touchArray[0], touchArray[1]);
                const currentAngle = getAngle(touchArray[0], touchArray[1]);

                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                const scaleChange = currentDistance / lastDistance;
                const newScaleX = userImgNode.scaleX() * scaleChange;
                const newScaleY = userImgNode.scaleY() * scaleChange;

                // é™åˆ¶ç¸®æ”¾ç¯„åœ (0.1x ~ 5x)
                if (newScaleX >= 0.1 && newScaleX <= 5) {
                    userImgNode.scaleX(newScaleX);
                    userImgNode.scaleY(newScaleY);
                }

                // è¨ˆç®—æ—‹è½‰å¢é‡ (ä½¿ç”¨è§’åº¦æ­¸ä¸€åŒ–é¿å…è·³èº)
                const rotationDelta = getRotationDelta(lastAngle, currentAngle);
                const newRotation = userImgNode.rotation() + rotationDelta * 180 / Math.PI;
                userImgNode.rotation(newRotation);

                // æ›´æ–°ä¸Šä¸€æ¬¡çš„ç‹€æ…‹
                lastDistance = currentDistance;
                lastAngle = currentAngle;

                photoLayer.batchDraw();
            }
        }, { passive: true });

        // TouchEnd: æ¸…ç†ç‹€æ…‹
        stageParent.addEventListener('touchend', (e) => {
            if (!userImgNode) return;

            // ç§»é™¤å·²çµæŸçš„è§¸æ§é»
            const remainingTouches = new Set(Array.from(e.touches).map(t => t.identifier));
            for (let id of touches.keys()) {
                if (!remainingTouches.has(id)) {
                    touches.delete(id);
                }
            }

            // é›™æŒ‡æ‰‹å‹¢çµæŸ
            if (touches.size < 2 && gestureActive) {
                gestureActive = false;
                userImgNode.draggable(true); // æ¢å¾©å–®æŒ‡æ‹–æ‹½
                tr.show(); // é¡¯ç¤º Transformer
                photoLayer.draw();
            }

            // æ‰€æœ‰è§¸æ§é»éƒ½çµæŸ
            if (touches.size === 0) {
                gestureActive = false;
                lastDistance = 0;
                lastAngle = 0;
            }
        }, { passive: true });

        stageParent.addEventListener('touchcancel', (e) => {
            touches.clear();
            gestureActive = false;
            lastDistance = 0;
            lastAngle = 0;
            if (userImgNode) {
                userImgNode.draggable(true);
                tr.show();
                photoLayer.draw();
            }
        }, { passive: true });

        // --- ä¸Šå‚³é‚è¼¯ ---
        let userImgNode = null;
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.body.style.cursor = 'wait';

            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image();
                imgObj.onload = function() {
                    if (userImgNode) userImgNode.destroy();

                    const stageW = stage.width();
                    const stageH = stage.height();
                    const scale = Math.max(stageW / imgObj.width, stageH / imgObj.height);

                    userImgNode = new Konva.Image({
                        image: imgObj,
                        x: stageW / 2,
                        y: stageH / 2,
                        width: imgObj.width,
                        height: imgObj.height,
                        scaleX: scale,
                        scaleY: scale,
                        offset: { x: imgObj.width / 2, y: imgObj.height / 2 },
                        draggable: true,
                    });

                    photoLayer.add(userImgNode);
                    tr.nodes([userImgNode]);
                    tr.moveToTop();
                    document.getElementById('upload-hint').style.display = 'none';
                    photoLayer.draw();

                    document.body.style.cursor = 'default';
                };
                imgObj.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- ğŸ”¥ æ ¸å¿ƒï¼šä¸‹è¼‰èˆ‡åˆ†äº«é‚è¼¯ (Web Share API + Blob URL) ---
        const shareBtn = document.getElementById('share-btn');
        const shareText = document.getElementById('share-text');
        const shareIcon = document.getElementById('share-icon');

        const downloadBtn = document.getElementById('download-btn');
        const downloadText = document.getElementById('download-text');
        const downloadIcon = document.getElementById('download-icon');

        // ğŸ†• åµæ¸¬å…§å»ºç€è¦½å™¨
        function isInAppBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return /micromessenger|line|fbav|instagram|twitter/.test(ua);
        }

        // ğŸ†• é¡¯ç¤ºåœ–ç‰‡ä¾›é•·æŒ‰ä¿å­˜ï¼ˆå…§å»ºç€è¦½å™¨æ›¿ä»£æ–¹æ¡ˆï¼‰
        function showImageForLongPress(blob, filename) {
            const url = URL.createObjectURL(blob);
            const win = window.open('', '_blank');
            if (win) {
                win.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>é•·æŒ‰ä¿å­˜åœ–ç‰‡</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                background: #0B1026;
                            }
                            img {
                                max-width: 100%;
                                border: 2px solid #D4AF37;
                                border-radius: 8px;
                            }
                            .hint {
                                color: #F3E5AB;
                                margin-top: 20px;
                                text-align: center;
                                font-family: sans-serif;
                            }
                        </style>
                    </head>
                    <body>
                        <img src="${url}" alt="${filename}" />
                        <div class="hint">
                            <p>ğŸ“± <strong>è«‹é•·æŒ‰åœ–ç‰‡</strong></p>
                            <p>ç„¶å¾Œé¸æ“‡ã€Œå„²å­˜åœ–ç‰‡ã€æˆ–ã€Œä¿å­˜åˆ°ç›¸å†Šã€</p>
                        </div>
                    </body>
                    </html>
                `);
                // å»¶é²æ¸…ç† URL
                setTimeout(() => URL.revokeObjectURL(url), 60000);
            }
        }

        // ğŸ†• é€šç”¨å‡½æ•¸ï¼šæº–å‚™åœ–ç‰‡è³‡æ–™ï¼ˆä½¿ç”¨ Blob URLï¼Œç„¡å¤§å°é™åˆ¶ï¼‰
        async function prepareImageData() {
            // éš±è—ç·¨è¼¯æ¡†
            tr.hide();
            photoLayer.draw();

            const pixelRatio = currentFrameData.width / stage.width();
            const filename = `2026-Photo-${currentFrameData.width}x${currentFrameData.height}.png`;

            // ä½¿ç”¨ toDataURL ç„¶å¾Œè½‰æ›ç‚º Blobï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
            return new Promise((resolve, reject) => {
                try {
                    const dataURL = stage.toDataURL({
                        pixelRatio: pixelRatio,
                        mimeType: 'image/png'
                    });

                    // å°‡ DataURL è½‰æ›ç‚º Blob
                    fetch(dataURL)
                        .then(res => res.blob())
                        .then(blob => {
                            resolve({ blob, filename });
                        })
                        .catch(reject);
                } catch (err) {
                    reject(err);
                }
            });
        }

        // ğŸ†• åŸ·è¡Œä¸‹è¼‰ï¼ˆä½¿ç”¨ Blob URLï¼‰
        function downloadWithBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // æ¸…ç† Blob URL
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // æ¢å¾© UI ç‹€æ…‹
        function restoreUI() {
            tr.show();
            photoLayer.draw();
        }

        // ğŸ”¥ åˆ†äº«æŒ‰éˆ•ï¼šè§¸ç™¼ Web Share APIï¼ˆæ”¯æ´å…§å»ºç€è¦½å™¨åµæ¸¬ï¼‰
        shareBtn.addEventListener('click', async function() {
            const originalText = shareText.innerText;
            const originalIconClass = shareIcon.className;

            shareBtn.disabled = true;
            downloadBtn.disabled = true;
            shareText.innerText = "Processing...";
            shareIcon.className = "fa-solid fa-circle-notch fa-spin";

            try {
                await new Promise(resolve => requestAnimationFrame(resolve));
                await new Promise(resolve => setTimeout(resolve, 50));

                const { blob, filename } = await prepareImageData();

                // ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºå…§å»ºç€è¦½å™¨
                if (isInAppBrowser()) {
                    const userChoice = confirm('æª¢æ¸¬åˆ°æ‚¨åœ¨æ‡‰ç”¨å…§ç€è¦½å™¨ä¸­ï¼Œåˆ†äº«åŠŸèƒ½å¯èƒ½å—é™ã€‚\n\næ˜¯å¦é–‹å•Ÿåœ–ç‰‡ä¾›é•·æŒ‰ä¿å­˜ï¼Ÿ');
                    if (userChoice) {
                        showImageForLongPress(blob, filename);
                    }
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æ”¯æ´ Web Share API
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], filename, { type: 'image/png' });
                    const shareData = {
                        files: [file],
                        title: 'My 2026 New Year Photo',
                        text: 'Celebrate 2026 with me! âœ¨\nhttps://pse.is/8j9x46'
                    };

                    if (navigator.canShare(shareData)) {
                        shareText.innerText = "Sharing...";
                        try {
                            await navigator.share(shareData);
                            // åˆ†äº«æˆåŠŸ
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.error('Share failed:', err);
                                alert("åˆ†äº«å¤±æ•—ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•");
                            }
                        }
                    } else {
                        alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´åˆ†äº«åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•");
                    }
                } else {
                    alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´åˆ†äº«åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•");
                }

            } catch (err) {
                console.error(err);
                alert("åˆ†äº«å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–ä½¿ç”¨ä¸‹è¼‰æŒ‰éˆ•");
            } finally {
                restoreUI();
                shareBtn.disabled = false;
                downloadBtn.disabled = false;
                shareText.innerText = originalText;
                shareIcon.className = originalIconClass;
            }
        });

        // ğŸ”¥ ä¸‹è¼‰æŒ‰éˆ•ï¼šç›´æ¥ä¸‹è¼‰åœ–ç‰‡ï¼ˆæ”¯æ´å…§å»ºç€è¦½å™¨åµæ¸¬ï¼‰
        downloadBtn.addEventListener('click', async function() {
            const originalText = downloadText.innerText;
            const originalIconClass = downloadIcon.className;

            downloadBtn.disabled = true;
            shareBtn.disabled = true;
            downloadText.innerText = "Saving...";
            downloadIcon.className = "fa-solid fa-circle-notch fa-spin";

            try {
                await new Promise(resolve => requestAnimationFrame(resolve));
                await new Promise(resolve => setTimeout(resolve, 50));

                const { blob, filename } = await prepareImageData();

                // ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºå…§å»ºç€è¦½å™¨
                if (isInAppBrowser()) {
                    const userChoice = confirm('æª¢æ¸¬åˆ°æ‚¨åœ¨æ‡‰ç”¨å…§ç€è¦½å™¨ä¸­ï¼Œä¸‹è¼‰åŠŸèƒ½å¯èƒ½å—é™ã€‚\n\næ˜¯å¦é–‹å•Ÿåœ–ç‰‡ä¾›é•·æŒ‰ä¿å­˜ï¼Ÿ');
                    if (userChoice) {
                        showImageForLongPress(blob, filename);
                    } else {
                        // ç”¨æˆ¶é¸æ“‡ä¸é–‹å•Ÿæ–°è¦–çª—ï¼Œå˜—è©¦ç›´æ¥ä¸‹è¼‰
                        downloadWithBlob(blob, filename);
                    }
                    return;
                }

                // ä½¿ç”¨ Blob URL ä¸‹è¼‰
                downloadWithBlob(blob, filename);

            } catch (err) {
                console.error(err);
                alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦");
            } finally {
                restoreUI();
                downloadBtn.disabled = false;
                shareBtn.disabled = false;
                downloadText.innerText = originalText;
                downloadIcon.className = originalIconClass;
            }
        });

        // RWDï¼šè¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—ç•«å¸ƒå¤§å°
        window.addEventListener('resize', () => {
            const newWidth = calculateOptimalWidth();
            if (currentFrameData) {
                const ratio = currentFrameData.height / currentFrameData.width;
                const newHeight = newWidth * ratio;

                // ğŸ†• iOS Safari ä¿®å¾©ï¼šåŒæ­¥æ›´æ–°å®¹å™¨å’Œ stage çš„å°ºå¯¸
                stage.width(newWidth);
                stage.height(newHeight);
                stageParent.style.height = `${newHeight}px`;

                if (currentFrameNode) {
                    currentFrameNode.width(newWidth);
                    currentFrameNode.height(newHeight);
                }
                stage.draw();
            }
        });

        // ç²’å­å‹•ç•«
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speed = Math.random() * 1 + 0.2;
                this.opacity = Math.random() * 0.5 + 0.1;
            }
            update() {
                this.y += this.speed;
                if (this.y > canvas.height) { this.reset(); this.y = -10; }
            }
            draw() {
                ctx.fillStyle = `rgba(212, 175, 55, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        for(let i=0; i<50; i++) particles.push(new Particle());
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();
    </script>
</body>
</html>
